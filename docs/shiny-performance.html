<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>7.3 Improving performance | Interactive web-based data visualization with R, plotly, and shiny</title>
  <meta name="description" content="A book example for a Chapman &amp; Hall book.">
  <meta name="generator" content="bookdown  and GitBook 2.6.7">

  <meta property="og:title" content="7.3 Improving performance | Interactive web-based data visualization with R, plotly, and shiny" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="A book example for a Chapman &amp; Hall book." />
  <meta name="github-repo" content="ropensci/plotly" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="7.3 Improving performance | Interactive web-based data visualization with R, plotly, and shiny" />
  <meta name="twitter:site" content="@cpsievert" />
  <meta name="twitter:description" content="A book example for a Chapman &amp; Hall book." />
  

<meta name="author" content="Carson Sievert">


<meta name="date" content="2019-01-04">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="shiny-plotly-inputs.html">
<link rel="next" href="advanced-applications.html">
<script src="libs/jquery/jquery.min.js"></script>
<link href="libs/gitbook/css/style.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/htmlwidgets/htmlwidgets.js"></script>
<script src="libs/plotly-binding/plotly.js"></script>
<script src="libs/typedarray/typedarray.min.js"></script>
<link href="libs/crosstalk/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk/js/crosstalk.min.js"></script>
<link href="libs/plotly-htmlwidgets-css/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="libs/plotly-main/plotly-latest.min.js"></script>
<link href="libs/jsoneditor/jsoneditor.min.css" rel="stylesheet" />
<script src="libs/jsoneditor/jsoneditor.min.js"></script>
<script src="libs/jsonedit-binding/jsonedit.js"></script>
<link href="libs/selectize/selectize.bootstrap3.css" rel="stylesheet" />
<script src="libs/selectize/selectize.min.js"></script>
<link href="libs/colourpicker/colourpicker.min.css" rel="stylesheet" />
<script src="libs/colourpicker/colourpicker.min.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="css/plotly.css" type="text/css" />
<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a></li>
<li class="chapter" data-level="1" data-path="two-approaches-one-object.html"><a href="two-approaches-one-object.html"><i class="fa fa-check"></i><b>1</b> Two approaches, one object</a><ul>
<li class="chapter" data-level="1.1" data-path="txhousing-case-study.html"><a href="txhousing-case-study.html"><i class="fa fa-check"></i><b>1.1</b> A case study of housing sales in Texas</a><ul>
<li class="chapter" data-level="1.1.1" data-path="txhousing-case-study.html"><a href="txhousing-case-study.html#ggplotly"><i class="fa fa-check"></i><b>1.1.1</b> The <code>ggplotly()</code> function</a></li>
<li class="chapter" data-level="1.1.2" data-path="txhousing-case-study.html"><a href="txhousing-case-study.html#the-plot_ly-interface"><i class="fa fa-check"></i><b>1.1.2</b> The <code>plot_ly()</code> interface</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="extending-ggplotly.html"><a href="extending-ggplotly.html"><i class="fa fa-check"></i><b>1.2</b> Extending <code>ggplotly()</code></a><ul>
<li class="chapter" data-level="1.2.1" data-path="extending-ggplotly.html"><a href="extending-ggplotly.html#customizing-the-layout"><i class="fa fa-check"></i><b>1.2.1</b> Customizing the layout</a></li>
<li class="chapter" data-level="1.2.2" data-path="extending-ggplotly.html"><a href="extending-ggplotly.html#modifying-layers"><i class="fa fa-check"></i><b>1.2.2</b> Modifying layers</a></li>
<li class="chapter" data-level="1.2.3" data-path="extending-ggplotly.html"><a href="extending-ggplotly.html#leveraging-statistical-output"><i class="fa fa-check"></i><b>1.2.3</b> Leveraging statistical output</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="the-plotly-cookbook.html"><a href="the-plotly-cookbook.html"><i class="fa fa-check"></i><b>2</b> The plotly cookbook</a><ul>
<li class="chapter" data-level="2.1" data-path="traces-and-other-plotly-js-lingo.html"><a href="traces-and-other-plotly-js-lingo.html"><i class="fa fa-check"></i><b>2.1</b> Traces and other plotly.js lingo</a></li>
<li class="chapter" data-level="2.2" data-path="scatter-traces.html"><a href="scatter-traces.html"><i class="fa fa-check"></i><b>2.2</b> Scatter traces</a><ul>
<li class="chapter" data-level="2.2.1" data-path="scatter-traces.html"><a href="scatter-traces.html#scatterplots"><i class="fa fa-check"></i><b>2.2.1</b> Scatterplots</a></li>
<li class="chapter" data-level="2.2.2" data-path="scatter-traces.html"><a href="scatter-traces.html#dotplots-error-bars"><i class="fa fa-check"></i><b>2.2.2</b> Dotplots &amp; error bars</a></li>
<li class="chapter" data-level="2.2.3" data-path="scatter-traces.html"><a href="scatter-traces.html#line-plots"><i class="fa fa-check"></i><b>2.2.3</b> Line plots</a></li>
<li class="chapter" data-level="2.2.4" data-path="scatter-traces.html"><a href="scatter-traces.html#segments"><i class="fa fa-check"></i><b>2.2.4</b> Segments</a></li>
<li class="chapter" data-level="2.2.5" data-path="scatter-traces.html"><a href="scatter-traces.html#ribbons"><i class="fa fa-check"></i><b>2.2.5</b> Ribbons</a></li>
<li class="chapter" data-level="2.2.6" data-path="scatter-traces.html"><a href="scatter-traces.html#polygons"><i class="fa fa-check"></i><b>2.2.6</b> Polygons</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="maps.html"><a href="maps.html"><i class="fa fa-check"></i><b>2.3</b> Maps</a><ul>
<li class="chapter" data-level="2.3.1" data-path="maps.html"><a href="maps.html#using-scatter-traces"><i class="fa fa-check"></i><b>2.3.1</b> Using scatter traces</a></li>
<li class="chapter" data-level="2.3.2" data-path="maps.html"><a href="maps.html#choropleths"><i class="fa fa-check"></i><b>2.3.2</b> Choropleths</a></li>
<li class="chapter" data-level="2.3.3" data-path="maps.html"><a href="maps.html#using-geom_sf"><i class="fa fa-check"></i><b>2.3.3</b> Using <code>geom_sf()</code></a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="bars-histograms.html"><a href="bars-histograms.html"><i class="fa fa-check"></i><b>2.4</b> Bars &amp; histograms</a><ul>
<li class="chapter" data-level="2.4.1" data-path="bars-histograms.html"><a href="bars-histograms.html#multiple-numeric-distributions"><i class="fa fa-check"></i><b>2.4.1</b> Multiple numeric distributions</a></li>
<li class="chapter" data-level="2.4.2" data-path="bars-histograms.html"><a href="bars-histograms.html#multiple-discrete-distributions"><i class="fa fa-check"></i><b>2.4.2</b> Multiple discrete distributions</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="boxplots.html"><a href="boxplots.html"><i class="fa fa-check"></i><b>2.5</b> Boxplots</a></li>
<li class="chapter" data-level="2.6" data-path="d-frequencies.html"><a href="d-frequencies.html"><i class="fa fa-check"></i><b>2.6</b> 2D frequencies</a><ul>
<li class="chapter" data-level="2.6.1" data-path="d-frequencies.html"><a href="d-frequencies.html#rectangular-binning-in-plotly.js"><i class="fa fa-check"></i><b>2.6.1</b> Rectangular binning in plotly.js</a></li>
<li class="chapter" data-level="2.6.2" data-path="d-frequencies.html"><a href="d-frequencies.html#rectangular-binning-in-r"><i class="fa fa-check"></i><b>2.6.2</b> Rectangular binning in R</a></li>
<li class="chapter" data-level="2.6.3" data-path="d-frequencies.html"><a href="d-frequencies.html#categorical-axes"><i class="fa fa-check"></i><b>2.6.3</b> Categorical axes</a></li>
</ul></li>
<li class="chapter" data-level="2.7" data-path="other-3d-plots.html"><a href="other-3d-plots.html"><i class="fa fa-check"></i><b>2.7</b> Other 3D plots</a></li>
<li class="chapter" data-level="2.8" data-path="raster-images.html"><a href="raster-images.html"><i class="fa fa-check"></i><b>2.8</b> Raster images</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="whats-a-data-view.html"><a href="whats-a-data-view.html"><i class="fa fa-check"></i><b>3</b> What’s a data view?</a></li>
<li class="chapter" data-level="4" data-path="arranging-multiple-views.html"><a href="arranging-multiple-views.html"><i class="fa fa-check"></i><b>4</b> Arranging multiple views</a><ul>
<li class="chapter" data-level="4.1" data-path="arranging-htmlwidgets.html"><a href="arranging-htmlwidgets.html"><i class="fa fa-check"></i><b>4.1</b> Arranging htmlwidgets</a></li>
<li class="chapter" data-level="4.2" data-path="merging-plotly-objects.html"><a href="merging-plotly-objects.html"><i class="fa fa-check"></i><b>4.2</b> Merging plotly objects</a><ul>
<li class="chapter" data-level="4.2.1" data-path="merging-plotly-objects.html"><a href="merging-plotly-objects.html#recursive-subplots"><i class="fa fa-check"></i><b>4.2.1</b> Recursive subplots</a></li>
<li class="chapter" data-level="4.2.2" data-path="merging-plotly-objects.html"><a href="merging-plotly-objects.html#ggplot2-subplots"><i class="fa fa-check"></i><b>4.2.2</b> ggplot2 subplots</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="navigating-many-views.html"><a href="navigating-many-views.html"><i class="fa fa-check"></i><b>4.3</b> Navigating many views</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="linking-views-client-side.html"><a href="linking-views-client-side.html"><i class="fa fa-check"></i><b>5</b> Linking views client-side</a><ul>
<li class="chapter" data-level="5.1" data-path="graphical-queries.html"><a href="graphical-queries.html"><i class="fa fa-check"></i><b>5.1</b> Graphical queries</a></li>
<li class="chapter" data-level="5.2" data-path="filter.html"><a href="filter.html"><i class="fa fa-check"></i><b>5.2</b> Highlight versus filter events</a></li>
<li class="chapter" data-level="5.3" data-path="querying-examples.html"><a href="querying-examples.html"><i class="fa fa-check"></i><b>5.3</b> Examples</a><ul>
<li class="chapter" data-level="5.3.1" data-path="querying-examples.html"><a href="querying-examples.html#trellis-linking"><i class="fa fa-check"></i><b>5.3.1</b> Querying facetted charts</a></li>
<li class="chapter" data-level="5.3.2" data-path="querying-examples.html"><a href="querying-examples.html#statistical-queries"><i class="fa fa-check"></i><b>5.3.2</b> Statistical queries</a></li>
<li class="chapter" data-level="5.3.3" data-path="querying-examples.html"><a href="querying-examples.html#statistical-queries-ggplot"><i class="fa fa-check"></i><b>5.3.3</b> Statistical queries with <code>ggplotly()</code></a></li>
<li class="chapter" data-level="5.3.4" data-path="querying-examples.html"><a href="querying-examples.html#geo-spatial-queries"><i class="fa fa-check"></i><b>5.3.4</b> Geo-spatial queries</a></li>
<li class="chapter" data-level="5.3.5" data-path="querying-examples.html"><a href="querying-examples.html#linking-with-other-htmlwidgets"><i class="fa fa-check"></i><b>5.3.5</b> Linking with other htmlwidgets</a></li>
<li class="chapter" data-level="5.3.6" data-path="querying-examples.html"><a href="querying-examples.html#generalized-pairs-plots"><i class="fa fa-check"></i><b>5.3.6</b> Generalized pairs plots</a></li>
<li class="chapter" data-level="5.3.7" data-path="querying-examples.html"><a href="querying-examples.html#querying-diagnostic-plots"><i class="fa fa-check"></i><b>5.3.7</b> Querying diagnostic plots</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="limitations.html"><a href="limitations.html"><i class="fa fa-check"></i><b>5.4</b> Limitations</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="animating-views.html"><a href="animating-views.html"><i class="fa fa-check"></i><b>6</b> Animating views</a><ul>
<li class="chapter" data-level="6.1" data-path="key-frame-animations.html"><a href="key-frame-animations.html"><i class="fa fa-check"></i><b>6.1</b> Key frame animations</a></li>
<li class="chapter" data-level="6.2" data-path="linking-animated-views.html"><a href="linking-animated-views.html"><i class="fa fa-check"></i><b>6.2</b> Linking animated views</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="linking-server-side.html"><a href="linking-server-side.html"><i class="fa fa-check"></i><b>7</b> Linking views server-side with shiny</a><ul>
<li class="chapter" data-level="7.1" data-path="hello-shiny.html"><a href="hello-shiny.html"><i class="fa fa-check"></i><b>7.1</b> Embedding plotly in shiny</a><ul>
<li class="chapter" data-level="7.1.1" data-path="hello-shiny.html"><a href="hello-shiny.html#your-first-shiny-app"><i class="fa fa-check"></i><b>7.1.1</b> Your first shiny app</a></li>
<li class="chapter" data-level="7.1.2" data-path="hello-shiny.html"><a href="hello-shiny.html#hiding-and-redrawing-on-resize"><i class="fa fa-check"></i><b>7.1.2</b> Hiding and redrawing on resize</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="shiny-plotly-inputs.html"><a href="shiny-plotly-inputs.html"><i class="fa fa-check"></i><b>7.2</b> Leveraging plotly input events</a><ul>
<li class="chapter" data-level="7.2.1" data-path="shiny-plotly-inputs.html"><a href="shiny-plotly-inputs.html#dragging-events"><i class="fa fa-check"></i><b>7.2.1</b> Dragging events</a></li>
<li class="chapter" data-level="7.2.2" data-path="shiny-plotly-inputs.html"><a href="shiny-plotly-inputs.html#d-events"><i class="fa fa-check"></i><b>7.2.2</b> 3D events</a></li>
<li class="chapter" data-level="7.2.3" data-path="shiny-plotly-inputs.html"><a href="shiny-plotly-inputs.html#edit-events"><i class="fa fa-check"></i><b>7.2.3</b> Edit events</a></li>
<li class="chapter" data-level="7.2.4" data-path="shiny-plotly-inputs.html"><a href="shiny-plotly-inputs.html#relayout-vs-restyle-events"><i class="fa fa-check"></i><b>7.2.4</b> Relayout vs restyle events</a></li>
<li class="chapter" data-level="7.2.5" data-path="shiny-plotly-inputs.html"><a href="shiny-plotly-inputs.html#scoping-events"><i class="fa fa-check"></i><b>7.2.5</b> Scoping events</a></li>
<li class="chapter" data-level="7.2.6" data-path="shiny-plotly-inputs.html"><a href="shiny-plotly-inputs.html#event-priority"><i class="fa fa-check"></i><b>7.2.6</b> Event priority</a></li>
<li class="chapter" data-level="7.2.7" data-path="shiny-plotly-inputs.html"><a href="shiny-plotly-inputs.html#handling-discrete-axes"><i class="fa fa-check"></i><b>7.2.7</b> Handling discrete axes</a></li>
<li class="chapter" data-level="7.2.8" data-path="shiny-plotly-inputs.html"><a href="shiny-plotly-inputs.html#reactive-vals"><i class="fa fa-check"></i><b>7.2.8</b> Accumulating and managing event data</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="shiny-performance.html"><a href="shiny-performance.html"><i class="fa fa-check"></i><b>7.3</b> Improving performance</a><ul>
<li class="chapter" data-level="7.3.1" data-path="shiny-performance.html"><a href="shiny-performance.html#proxies"><i class="fa fa-check"></i><b>7.3.1</b> Partial plotly updates</a></li>
<li class="chapter" data-level="7.3.2" data-path="shiny-performance.html"><a href="shiny-performance.html#partial-update-examples"><i class="fa fa-check"></i><b>7.3.2</b> Partial update examples</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="advanced-applications.html"><a href="advanced-applications.html"><i class="fa fa-check"></i><b>7.4</b> Advanced applications</a><ul>
<li class="chapter" data-level="7.4.1" data-path="advanced-applications.html"><a href="advanced-applications.html#drill-down"><i class="fa fa-check"></i><b>7.4.1</b> Drill-down</a></li>
<li class="chapter" data-level="7.4.2" data-path="advanced-applications.html"><a href="advanced-applications.html#crossfilter"><i class="fa fa-check"></i><b>7.4.2</b> Cross-filter</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="discussion.html"><a href="discussion.html"><i class="fa fa-check"></i><b>7.5</b> Discussion</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="publishing-views.html"><a href="publishing-views.html"><i class="fa fa-check"></i><b>8</b> Publishing views</a><ul>
<li class="chapter" data-level="8.1" data-path="saving-and-embedding.html"><a href="saving-and-embedding.html"><i class="fa fa-check"></i><b>8.1</b> Saving and embedding</a></li>
<li class="chapter" data-level="8.2" data-path="exporting-static-images.html"><a href="exporting-static-images.html"><i class="fa fa-check"></i><b>8.2</b> Exporting static images</a><ul>
<li class="chapter" data-level="8.2.1" data-path="exporting-static-images.html"><a href="exporting-static-images.html#with-code"><i class="fa fa-check"></i><b>8.2.1</b> With code</a></li>
<li class="chapter" data-level="8.2.2" data-path="exporting-static-images.html"><a href="exporting-static-images.html#from-a-browser"><i class="fa fa-check"></i><b>8.2.2</b> From a browser</a></li>
<li class="chapter" data-level="8.2.3" data-path="exporting-static-images.html"><a href="exporting-static-images.html#sizing-exports"><i class="fa fa-check"></i><b>8.2.3</b> Sizing exports</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="interactive-editing.html"><a href="interactive-editing.html"><i class="fa fa-check"></i><b>8.3</b> Interactive editing</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="javascript.html"><a href="javascript.html"><i class="fa fa-check"></i><b>9</b> Extending plotly with JavaScript</a><ul>
<li class="chapter" data-level="9.1" data-path="json.html"><a href="json.html"><i class="fa fa-check"></i><b>9.1</b> Working with JSON</a><ul>
<li class="chapter" data-level="9.1.1" data-path="json.html"><a href="json.html#assignment-subsetting-and-iteration"><i class="fa fa-check"></i><b>9.1.1</b> Assignment, subsetting, and iteration</a></li>
<li class="chapter" data-level="9.1.2" data-path="json.html"><a href="json.html#mapping-r-to-json"><i class="fa fa-check"></i><b>9.1.2</b> Mapping R to JSON</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="js-event-handlers.html"><a href="js-event-handlers.html"><i class="fa fa-check"></i><b>9.2</b> Adding custom event handlers</a></li>
<li class="chapter" data-level="9.3" data-path="supplying-custom-data.html"><a href="supplying-custom-data.html"><i class="fa fa-check"></i><b>9.3</b> Supplying custom data</a></li>
<li class="chapter" data-level="9.4" data-path="incorporating-other-client-side-tools.html"><a href="incorporating-other-client-side-tools.html"><i class="fa fa-check"></i><b>9.4</b> Incorporating other client-side tools</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="developer-facing-topics.html"><a href="developer-facing-topics.html"><i class="fa fa-check"></i><b>10</b> Developer-facing topics</a><ul>
<li class="chapter" data-level="10.1" data-path="translating-custom-ggplot2-geoms.html"><a href="translating-custom-ggplot2-geoms.html"><i class="fa fa-check"></i><b>10.1</b> Translating custom ggplot2 geoms</a></li>
<li class="chapter" data-level="10.2" data-path="designing-an-htmlwidget-interface.html"><a href="designing-an-htmlwidget-interface.html"><i class="fa fa-check"></i><b>10.2</b> Designing an htmlwidget interface</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Interactive web-based data visualization with R, plotly, and shiny</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="shiny-performance" class="section level2">
<h2><span class="header-section-number">7.3</span> Improving performance</h2>
<p>Multiple linked views are known to help facilitate data exploration, but latency in the user interface is also known to reduce exploratory findings <span class="citation">(Heer <a href="#ref-2014-latency">2014</a>)</span>. In addition to the advice and techniques offered in section <a href="shiny-performance.html#proxies">7.3.1</a> for improving <strong>plotly</strong>’s performance in general, there are also techniques specifically for <strong>shiny</strong> apps that you can leverage to help improve the user experience.</p>
<p>When trying to speed-up any slow code, the first step is always to identify the main contributor(s) to the poor performance. In some cases, your intuition may serve as a helpful guide, but in order to <em>really</em> see what’s going on, consider using a code profiling tool like <strong>profvis</strong> <span class="citation">(Chang and Luraschi <a href="#ref-profvis">2018</a>)</span>. The <strong>profvis</strong> package provides a really nice way to visualize and isolate slow running R code in general, but it also works well for profiling <strong>shiny</strong> apps <span class="citation">(RStudio <a href="#ref-profvis-shiny">2014</a><a href="#ref-profvis-shiny">b</a>)</span>.</p>
<p>A lot of different factors can contribute to poor performance in a <strong>shiny</strong> app, but thankfully, the <strong>shiny</strong> ecosystem provides an extensive toolbox for diagnosing and improving performance. The <strong>profvis</strong> package is great for identifying “universal” performance issues, but when deploying shiny apps into production, there may be other potential bottlenecks that surface. This is largely due to R’s single-threaded nature – a single R server has difficulty scaling to many users because, by default, it can only handle one job at a time. The <strong>shinyloadtest</strong> package helps to identify those bottlenecks and <strong>shiny</strong>’s support for asynchronous programming with <strong>promises</strong> is one way to address them without increasing computational infrastructure (e.g. multiple servers) <span class="citation">(Dipert, Schloerke, and Borges <a href="#ref-shinyloadtest">2018</a>)</span>; <span class="citation">(Cheng <a href="#ref-promises">2018</a><a href="#ref-promises">b</a>)</span>.</p>
<p>To reiterate the section on “Improving performance and scalability” in <strong>shiny</strong> from <span class="citation">Cheng (<a href="#ref-async">2018</a><a href="#ref-async">a</a>)</span>, you have a number of tools available to address performance:</p>
<ol style="list-style-type: decimal">
<li>The <strong>profvis</strong> package for profiling code.</li>
<li>Cache computations ahead-of-time.</li>
<li>Cache computations at run time.</li>
<li>Cache computations through chaining reactive expressions.</li>
<li>Leverage multiple R processes and/or servers.</li>
<li>Async programming with <strong>promises</strong></li>
</ol>
<p>We won’t directly cover these topics, but it’s worth noting that all these tools are primarily designed for improving <em>server-side</em> performance of a <strong>shiny</strong> app. It could be that sluggish plots in your <strong>shiny</strong> app are due to sluggish server-side code, but it could also be that some of the sluggishness is due to redundant work being done client-side by <strong>plotly</strong>. Avoiding this redundancy, as covered in section <a href="shiny-performance.html#proxies">7.3.1</a>, can be difficult, and it doesn’t always lead to noticable improvements. However, when you need to put lots of graphical elements on a plot, then update just a portion of the plot in response to user event(s), the added complexity can be worth the effort.</p>
<div id="proxies" class="section level3">
<h3><span class="header-section-number">7.3.1</span> Partial plotly updates</h3>
<p>By default, when <code>renderPlotly()</code> renders a new <strong>plotly</strong> graph it’s essentially equivalent to executing a block of R code from your R prompt and generating a new <strong>plotly</strong> graph from scratch. That means, not only does the R code need to re-execute to generate a new R object, but it also has to re-serialize that object as JSON, and your browser has to re-render the graph from the new JSON object (more on this in section <a href="#performance"><strong>??</strong></a>). In cases where your <strong>plotly</strong> graph does not need to serialize a lot data and/or render lots of graphical elements, as in Figure <a href="hello-shiny.html#fig:shiny-intro">7.1</a>, you can likely perform a full redraw without noticable glitches, especially if you use canvas-based rendering rather than SVG (i.e., <code>toWebGL()</code>). Generally speaking, you should try very hard to make your app responsive before adopting partial <strong>plotly</strong> updates in <strong>shiny</strong>. It makes your app logic easy to reason about because you don’t have to worry about maintaining the state of the graph, but sometimes you have no other choice.</p>
<p>On initial page load, <strong>plotly</strong> graphs must be drawn from stratch, but when responding to certain user events, often times a partial update to an existing plot is sufficient and more responsive. Take, for instance, the difference between Figure <a href="shiny-performance.html#fig:shiny-scatterplot">7.15</a>, which does a full redraw on every update, and Figure <a href="shiny-performance.html#fig:shiny-scatterplot-performant">7.16</a>, which does a partial update after initial load. Both of these <strong>shiny</strong> apps display a scatterplot with 100,000 points and allow a user to overlay a fitted line through a checkbox. The key difference is that in Figure <a href="shiny-performance.html#fig:shiny-scatterplot">7.15</a>, the <strong>plotly</strong> graph is regenerated from scratch everytime the value of <code>input$smooth</code> changes, whereas in Figure <a href="shiny-performance.html#fig:shiny-scatterplot-performant">7.16</a> only the fitted line is added/removed from the <strong>plotly</strong>. Since the main bottleneck lies in redrawing the points, Figure <a href="shiny-performance.html#fig:shiny-scatterplot-performant">7.16</a> can add/remove the fitted line is a much more responsive fashion.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(shiny)
<span class="kw">library</span>(plotly)

<span class="co"># Generate 100,000 observations from 2 correlated random variables</span>
d &lt;-<span class="st"> </span>MASS<span class="op">::</span><span class="kw">mvrnorm</span>(<span class="fl">1e6</span>, <span class="dt">mu =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="dt">Sigma =</span> <span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="dv">1</span>), <span class="dv">2</span>, <span class="dv">2</span>))
d &lt;-<span class="st"> </span><span class="kw">setNames</span>(<span class="kw">as.data.frame</span>(d), <span class="kw">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>))

<span class="co"># fit a simple linear model</span>
m &lt;-<span class="st"> </span><span class="kw">lm</span>(y <span class="op">~</span><span class="st"> </span>x, <span class="dt">data =</span> d)

<span class="co"># generate y predictions over a grid of 10 x values</span>
dpred &lt;-<span class="st"> </span><span class="kw">data.frame</span>(
  <span class="dt">x =</span> <span class="kw">seq</span>(<span class="kw">min</span>(d<span class="op">$</span>x), <span class="kw">max</span>(d<span class="op">$</span>x), <span class="dt">length.out =</span> <span class="dv">10</span>)
)
dpred<span class="op">$</span>yhat &lt;-<span class="st"> </span><span class="kw">predict</span>(m, <span class="dt">newdata =</span> dpred)

ui &lt;-<span class="st"> </span><span class="kw">fluidPage</span>(
  <span class="kw">plotlyOutput</span>(<span class="st">&quot;scatterplot&quot;</span>),
  <span class="kw">checkboxInput</span>(<span class="st">&quot;smooth&quot;</span>, <span class="dt">label =</span> <span class="st">&quot;Overlay fitted line?&quot;</span>, <span class="dt">value =</span> <span class="ot">FALSE</span>)
)

server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session) {
  
  output<span class="op">$</span>scatterplot &lt;-<span class="st"> </span><span class="kw">renderPlotly</span>({
    
    p &lt;-<span class="st"> </span><span class="kw">plot_ly</span>(d, <span class="dt">x   =</span> <span class="op">~</span>x, <span class="dt">y =</span> <span class="op">~</span>y) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">add_markers</span>(<span class="dt">color =</span> <span class="kw">I</span>(<span class="st">&quot;black&quot;</span>), <span class="dt">alpha =</span> <span class="fl">0.05</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">toWebGL</span>() <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">layout</span>(<span class="dt">showlegend =</span> <span class="ot">FALSE</span>)
    
    <span class="cf">if</span> (<span class="op">!</span>input<span class="op">$</span>smooth) <span class="kw">return</span>(p)
      
    <span class="kw">add_lines</span>(p, <span class="dt">data =</span> dpred, <span class="dt">x =</span> <span class="op">~</span>x, <span class="dt">y =</span> <span class="op">~</span>yhat, <span class="dt">color =</span> <span class="kw">I</span>(<span class="st">&quot;red&quot;</span>))
  })
  
}

<span class="kw">shinyApp</span>(ui, server)</code></pre>
<div class="figure"><span id="fig:shiny-scatterplot"></span>
<iframe src="https://player.vimeo.com/video/307597740?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 7.15: Naive implementation of a shiny app that optionally overlays a fitted line to a scatterplot. A full redraw of the plot is performed everytime the checkbox is clicked, leading to an unnecessarily slow plot.
</p>
</div>
<p>In terms of the implementation behind Figure <a href="shiny-performance.html#fig:shiny-scatterplot">7.15</a> and <a href="shiny-performance.html#fig:shiny-scatterplot-performant">7.16</a>, the only difference resides in the <code>server</code> definition. In Figure <a href="shiny-performance.html#fig:shiny-scatterplot-performant">7.16</a>, the <code>renderPlotly()</code> statement no longer has a dependency on input values, so that code is only executed once (on page load) to generate the initial view of the scatterplot. The logic behind adding and removing the fitted line is handled through an <code>observe()</code> block – this reactive expression watches the <code>input$smooth</code> input value and modifies the <code>output$scatterplot</code> widget whenever it changes. To trigger a modification of a <strong>plotly</strong> output widget, you must create a proxy object with <code>plotlyProxy()</code> that references the relevant output ID. Once a proxy object is created, you can invoke any sequence of <a href="https://plot.ly/javascript/plotlyjs-function-reference/#plotlymaketemplate">plotly.js function(s)</a> on it with <code>plotlyProxyInvoke()</code>. Invoking a method with the correct arguments can be tricky and requires knowledge of plotly.js because <code>plotlyProxyInvoke()</code> will send these arguments directly to the plotly.js method and therefore doesn’t support the same ‘high-level’ semantics that <code>plot_ly()</code> does.</p>
<pre class="sourceCode r"><code class="sourceCode r">server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session) {
  
  output<span class="op">$</span>scatterplot &lt;-<span class="st"> </span><span class="kw">renderPlotly</span>({
    <span class="kw">plot_ly</span>(d, <span class="dt">x =</span> <span class="op">~</span>x, <span class="dt">y =</span> <span class="op">~</span>y) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">add_markers</span>(<span class="dt">color =</span> <span class="kw">I</span>(<span class="st">&quot;black&quot;</span>), <span class="dt">alpha =</span> <span class="fl">0.05</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">toWebGL</span>()
  })
  
  <span class="kw">observe</span>({
    
    <span class="cf">if</span> (input<span class="op">$</span>smooth) {
      
      <span class="co"># this is essentially the plotly.js way of doing</span>
      <span class="co"># `p %&gt;% add_lines(x = ~x, y = ~yhat) %&gt;% toWebGL()`</span>
      <span class="co"># without having to redraw the entire plot</span>
      <span class="kw">plotlyProxy</span>(<span class="st">&quot;scatterplot&quot;</span>, session) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">plotlyProxyInvoke</span>(
          <span class="st">&quot;addTraces&quot;</span>, 
          <span class="kw">list</span>(
            <span class="dt">x =</span> dpred<span class="op">$</span>x,
            <span class="dt">y =</span> dpred<span class="op">$</span>yhat,
            <span class="dt">type =</span> <span class="st">&quot;scattergl&quot;</span>,
            <span class="dt">mode =</span> <span class="st">&quot;lines&quot;</span>,
            <span class="dt">line =</span> <span class="kw">list</span>(<span class="dt">color =</span> <span class="st">&quot;red&quot;</span>)
          )
        )
    } <span class="cf">else</span> {
    
      <span class="co"># JavaScript index starts at 0, so the &#39;1&#39; here really means</span>
      <span class="co"># &quot;delete the second traces (i.e., the fitted line)&quot;</span>
      <span class="kw">plotlyProxy</span>(<span class="st">&quot;scatterplot&quot;</span>, session) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">plotlyProxyInvoke</span>(<span class="st">&quot;deleteTraces&quot;</span>, <span class="dv">1</span>)
    }
    
  })
  
}</code></pre>
<div class="figure"><span id="fig:shiny-scatterplot-performant"></span>
<iframe src="https://player.vimeo.com/video/307598567?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 7.16: A more responsive version of Figure <a href="shiny-performance.html#fig:shiny-scatterplot">7.15</a>.
</p>
</div>
<p>Figure <a href="shiny-performance.html#fig:shiny-scatterplot">7.15</a> demonstrates a common use case where partial updates can be helpful, but there are other not-so-obvious cases. The next section covers a range of examples where you’ll see how to leverage partial updates to implement smooth ‘streaming’ visuals, avoid resetting axis ranges, avoid flickering basemap layers, and more.</p>
</div>
<div id="partial-update-examples" class="section level3">
<h3><span class="header-section-number">7.3.2</span> Partial update examples</h3>
<p>The last section explains why you may want to leverage partial <strong>plotly</strong> updates in <strong>shiny</strong> to get more responsive updates through an example. That example leveraged the <a href="https://plot.ly/javascript/plotlyjs-function-reference/">plotly.js functions</a> <code>Plotly.addTraces()</code> and <code>Plotly.deleteTraces()</code> to add/remove a layer to a plot after it’s initial draw. There are numerous other plotly.js functions that can be handy for a variety of use cases, some of the most widely used ones are: <code>Plotly.restyle()</code> for updating data visuals (section <a href="shiny-performance.html#restyle">7.3.2.1</a>), <code>Plotly.relayout()</code> for updating the layout (section <a href="shiny-performance.html#relayout">7.3.2.2</a>), and <code>Plotly.extendTraces()</code> for streaming data (section <a href="shiny-performance.html#streaming">7.3.2.3</a>).</p>
<div id="restyle" class="section level4">
<h4><span class="header-section-number">7.3.2.1</span> Modifying traces</h4>
<p>All <strong>plotly</strong> figures have two main components: traces (i.e., mapping from data to visuals) and layout. The plotly.js function <code>Plotly.restyle()</code> is for modifying any existing traces. In addition to being a performant way to modify existing data and/or visual properties, it also has the added benefit of not affecting the current layout of the graph. Notice how, in Figure <a href="shiny-performance.html#fig:shiny-partial-restyle">7.17</a> for example, when the size of the marker/path changes, it doesn’t change the camera’s view of the 3D plot that the user altered after initial draw. If these input widgets triggered a full redraw of the plot, the camera would be reset to it’s initial state.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(shiny)
<span class="kw">library</span>(plotly)

ui &lt;-<span class="st"> </span><span class="kw">fluidPage</span>(
  <span class="kw">sliderInput</span>(<span class="st">&quot;marker&quot;</span>, <span class="st">&quot;Marker size&quot;</span>, <span class="dt">min =</span> <span class="dv">0</span>, <span class="dt">max =</span> <span class="dv">20</span>, <span class="dt">value =</span> <span class="dv">8</span>),
  <span class="kw">sliderInput</span>(<span class="st">&quot;path&quot;</span>, <span class="st">&quot;Path size&quot;</span>, <span class="dt">min =</span> <span class="dv">0</span>, <span class="dt">max =</span> <span class="dv">30</span>, <span class="dt">value =</span> <span class="dv">2</span>),
  <span class="kw">plotlyOutput</span>(<span class="st">&quot;p&quot;</span>)
)

server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session) {
  
  output<span class="op">$</span>p &lt;-<span class="st"> </span><span class="kw">renderPlotly</span>({
    <span class="kw">plot_ly</span>(
      economics, <span class="dt">x =</span> <span class="op">~</span>pce, <span class="dt">y =</span> <span class="op">~</span>psavert, <span class="dt">z =</span> <span class="op">~</span>unemploy, 
      <span class="dt">color =</span> <span class="op">~</span><span class="kw">as.numeric</span>(date), <span class="dt">mode =</span> <span class="st">&quot;markers+lines&quot;</span>
    )
  })
  
  <span class="kw">observeEvent</span>(input<span class="op">$</span>marker, {
    <span class="kw">plotlyProxy</span>(<span class="st">&quot;p&quot;</span>, session) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">plotlyProxyInvoke</span>(
        <span class="st">&quot;restyle&quot;</span>, 
        <span class="co"># could also do list(marker = list(size = input$marker))</span>
        <span class="co"># but that overwrites the existing marker definition</span>
        <span class="co"># https://github.com/plotly/plotly.js/issues/1866#issuecomment-314115744</span>
        <span class="kw">list</span>(<span class="dt">marker.size =</span> input<span class="op">$</span>marker)
      )
  })
  
  <span class="kw">observeEvent</span>(input<span class="op">$</span>path, {
    <span class="kw">plotlyProxy</span>(<span class="st">&quot;p&quot;</span>, session) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">plotlyProxyInvoke</span>(
        <span class="st">&quot;restyle&quot;</span>, <span class="kw">list</span>(<span class="dt">line.width =</span> input<span class="op">$</span>path)
      )
  })
  
}

<span class="kw">shinyApp</span>(ui, server)</code></pre>
<div class="figure"><span id="fig:shiny-partial-restyle"></span>
<iframe src="https://player.vimeo.com/video/307598144?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 7.17: Using <code>Plotly.restyle()</code> to change just the width of a path and markers along that path in response to changes to <strong>shiny</strong> input sliders.
</p>
</div>
<p>One un-intuitive thing about <code>Plotly.restyle()</code> is that it fully replaces object (i.e., attributes that contain attributes) definitions like <code>marker</code> by default. To modify just a particular attribute of an object, like the size of a marker, you must replace that attribute directly (hence <code>marker.size</code>). As mentioned in the <a href="https://plot.ly/javascript/plotlyjs-function-reference/#plotlyrestyle">official documentation</a>, by default, modifications are applied to all traces, but specific traces can be targeted through their trace index (which starts at 0, because JavaScript)!</p>
</div>
<div id="relayout" class="section level4">
<h4><span class="header-section-number">7.3.2.2</span> Updating the layout</h4>
<p>All <strong>plotly</strong> figures have two main components: traces (i.e., mapping from data to visuals) and layout. The plotly.js function <code>Plotly.relayout()</code> modifies the layout component, so it can control a wide variety of things such titles, axis definitions, annotations, shapes, and many other things. It can even be used to change the basemap layer of a Mapbox-powered layout, as in Figure <a href="shiny-performance.html#fig:shiny-mapbox-relayout">7.18</a>. Note how this example uses <code>schema()</code> to grab all the pre-packaged basemap layers and create a dropdown of those options, but you can also provide a URL to a <a href="https://www.mapbox.com/help/create-a-custom-style/">custom basemap style</a>.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(shiny)
<span class="kw">library</span>(plotly)

<span class="co"># get all the available mapbox styles</span>
mapStyles &lt;-<span class="st"> </span><span class="kw">schema</span>()<span class="op">$</span>layout<span class="op">$</span>layoutAttributes<span class="op">$</span>mapbox<span class="op">$</span>style<span class="op">$</span>values

ui &lt;-<span class="st"> </span><span class="kw">fluidPage</span>(
  <span class="kw">selectInput</span>(<span class="st">&quot;style&quot;</span>, <span class="st">&quot;Select a mapbox style&quot;</span>, mapStyles),
  <span class="kw">plotlyOutput</span>(<span class="st">&quot;map&quot;</span>)
)

server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session) {
  
  output<span class="op">$</span>map &lt;-<span class="st"> </span><span class="kw">renderPlotly</span>({
    <span class="kw">plot_mapbox</span>()
  })
  
  <span class="kw">observeEvent</span>(input<span class="op">$</span>style, {
    <span class="kw">plotlyProxy</span>(<span class="st">&quot;map&quot;</span>, session) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">plotlyProxyInvoke</span>(
        <span class="st">&quot;relayout&quot;</span>,
        <span class="kw">list</span>(<span class="dt">mapbox =</span> <span class="kw">list</span>(<span class="dt">style =</span> input<span class="op">$</span>style))
      )
  })
  
}

<span class="kw">shinyApp</span>(ui, server)</code></pre>
<div class="figure"><span id="fig:shiny-mapbox-relayout"></span>
<iframe src="https://player.vimeo.com/video/307598178?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 7.18: Using <code>Plotly.relayout()</code> to ‘auto-range’ the y-axis in response to changes in the x-axis range.
</p>
</div>
<p>Figure <a href="shiny-performance.html#fig:shiny-rangeslider-relayout">7.19</a> demonstrates a clever use of <code>Plotly.relayout()</code> to set the y-axis range in response to changes in the x-axis range.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(shiny)
<span class="kw">library</span>(plotly)

ui &lt;-<span class="st"> </span><span class="kw">fluidPage</span>(
  <span class="kw">plotlyOutput</span>(<span class="st">&quot;plot&quot;</span>)
)

server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session) {
  
  p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(txhousing) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(date, median, <span class="dt">group =</span> city))
  
  output<span class="op">$</span>plot &lt;-<span class="st"> </span><span class="kw">renderPlotly</span>({
    <span class="kw">ggplotly</span>(p, <span class="dt">dynamicTicks =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">rangeslider</span>() 
  })
  
  <span class="kw">observeEvent</span>(<span class="kw">event_data</span>(<span class="st">&quot;plotly_relayout&quot;</span>), {
    d &lt;-<span class="st"> </span><span class="kw">event_data</span>(<span class="st">&quot;plotly_relayout&quot;</span>)
    xmin &lt;-<span class="st"> </span><span class="cf">if</span> (<span class="kw">length</span>(d[[<span class="st">&quot;xaxis.range[0]&quot;</span>]])) d[[<span class="st">&quot;xaxis.range[0]&quot;</span>]] <span class="cf">else</span> d[[<span class="st">&quot;xaxis.range&quot;</span>]][<span class="dv">1</span>]
    xmax &lt;-<span class="st"> </span><span class="cf">if</span> (<span class="kw">length</span>(d[[<span class="st">&quot;xaxis.range[1]&quot;</span>]])) d[[<span class="st">&quot;xaxis.range[1]&quot;</span>]] <span class="cf">else</span> d[[<span class="st">&quot;xaxis.range&quot;</span>]][<span class="dv">2</span>]
    <span class="cf">if</span> (<span class="kw">is.null</span>(xmin) <span class="op">||</span><span class="st"> </span><span class="kw">is.null</span>(xmax)) <span class="kw">return</span>(<span class="ot">NULL</span>)
    
    <span class="co"># compute the y-range based on the new x-range</span>
    idx &lt;-<span class="st"> </span><span class="kw">with</span>(txhousing, xmin <span class="op">&lt;=</span><span class="st"> </span>date <span class="op">&amp;</span><span class="st"> </span>date <span class="op">&lt;=</span><span class="st"> </span>xmax)
    yrng &lt;-<span class="st"> </span><span class="kw">extendrange</span>(txhousing<span class="op">$</span>median[idx])
    
    <span class="kw">plotlyProxy</span>(<span class="st">&quot;plot&quot;</span>, session) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">plotlyProxyInvoke</span>(<span class="st">&quot;relayout&quot;</span>, <span class="kw">list</span>(<span class="dt">yaxis =</span> <span class="kw">list</span>(<span class="dt">range =</span> yrng)))
  })
  
  yRange &lt;-<span class="st"> </span><span class="kw">range</span>(txhousing<span class="op">$</span>median, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
  <span class="kw">observeEvent</span>(<span class="kw">event_data</span>(<span class="st">&quot;plotly_doubleclick&quot;</span>), {
    
    <span class="kw">plotlyProxy</span>(<span class="st">&quot;plot&quot;</span>, session) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">plotlyProxyInvoke</span>(<span class="st">&quot;relayout&quot;</span>, <span class="kw">list</span>(<span class="dt">yaxis =</span> <span class="kw">list</span>(<span class="dt">range =</span> yRange)))
    
  })
  
  
}

<span class="kw">shinyApp</span>(ui, server)</code></pre>
<div class="figure"><span id="fig:shiny-rangeslider-relayout"></span>
<iframe src="https://player.vimeo.com/video/307598689?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 7.19: Using <code>Plotly.relayout()</code> to ‘auto-range’ the y-axis in response to changes in the x-axis range.
</p>
</div>
</div>
<div id="streaming" class="section level4">
<h4><span class="header-section-number">7.3.2.3</span> Streaming data</h4>
<p>At this point, we’ve seen how to add/remove traces (e.g., add/remove a fitted line, as in Figure <a href="shiny-performance.html#fig:shiny-scatterplot-performant">7.16</a>), and how to edit specific trace properties (e.g., change marker size or path width, as in Figure <a href="shiny-performance.html#fig:shiny-partial-restyle">7.17</a>), but what about adding more data to existing trace(s)? This is a job for the plotly.js function <code>Plotly.extendTraces()</code> and/or <code>Plotly.prependTraces()</code> which can used to efficiently ‘stream’ data into an existing plot, as done in Figure <a href="shiny-performance.html#fig:shiny-stream">7.20</a>.</p>
<p>The implementation behind Figure <a href="shiny-performance.html#fig:shiny-stream">7.20</a>, an elementary example of a random walk, makes use of some fairly sophisicated reactive programming tools from <strong>shiny</strong>. Similar to most examples from this section, the <code>renderPlotly()</code> statement is executed once on initial load to draw the initial line with just two data points. By default, the plot is not streaming, but streaming can be turned on or off through the click of a button, which will require the app to know (at all times) whether or not we are in a streaming state. One way to do this is to leverage <strong>shiny</strong>’s <code>reactiveValues()</code>, which act like input values, but can be created and modified entirely server-side, making them quite useful for maintaining state of an application. In this case, the reactive value <code>rv$stream</code> is used to store the streaming state, which is turned on/off whenever the <code>actionButton()</code> is clicked (via the <code>observeEvent()</code> logic).</p>
<p>Even if the app is not streaming, there is still constant client/server communication because of the use of <code>invalidateLater()</code> inside the <code>observe()</code>. This effectively tells <strong>shiny</strong> to re-evaluate the <code>observe()</code> block every 100 milliseconds. If the app isn’t in streaming mode, then it exits early without doing anything. If the app is streaming, then we first use <code>sample()</code> to randomly draw either -1 or 1 (with equal probability) and use the result to update the most recent (x, y) state. This is done by assigning a new value to the reactive values <code>rv$y</code> and <code>rv$n</code> within an <code>isolate()</code>d context – if this assignment happened outside of an <code>isolate()</code>d context it would cause the reactive expression to be invalidated and cause an infinite loop! Once we have the new (x, y) point stored away, <code>Plotly.extendTraces()</code> can be used to add the new point to the plotly graph.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(shiny)
<span class="kw">library</span>(plotly)

ui &lt;-<span class="st"> </span><span class="kw">fluidPage</span>(
  <span class="kw">actionButton</span>(<span class="st">&quot;stream&quot;</span>, <span class="st">&quot;Turn stream on/off&quot;</span>),
  <span class="kw">plotlyOutput</span>(<span class="st">&quot;plot&quot;</span>)
)

server &lt;-<span class="st"> </span><span class="cf">function</span>(input, output, session) {
  
  <span class="co"># initial values</span>
  yint &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)
  
  <span class="co"># initiate graph with initial values</span>
  output<span class="op">$</span>plot &lt;-<span class="st"> </span><span class="kw">renderPlotly</span>({
    <span class="kw">plot_ly</span>(<span class="dt">y =</span> yint, <span class="dt">x =</span> <span class="kw">seq_along</span>(yint)) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">add_lines</span>()
  })
  
  <span class="co"># reactiveValues() act very much like input values, but may be used to </span>
  <span class="co"># maintain state (e.g., are we currently streaming?)</span>
  rv &lt;-<span class="st"> </span><span class="kw">reactiveValues</span>(
    <span class="dt">stream =</span> <span class="ot">FALSE</span>,
    <span class="dt">yend =</span> <span class="kw">sum</span>(yint), 
    <span class="dt">n =</span> <span class="kw">length</span>(yint)
  )
  
  <span class="co"># turn streaming on/off when the button is pressed</span>
  <span class="kw">observeEvent</span>(input<span class="op">$</span>stream, {
    rv<span class="op">$</span>stream &lt;-<span class="st"> </span><span class="cf">if</span> (rv<span class="op">$</span>stream) <span class="ot">FALSE</span> <span class="cf">else</span> <span class="ot">TRUE</span>
  })
  
  <span class="kw">observe</span>({
    <span class="co"># if we&#39;re not streaming, don&#39;t do anything</span>
    <span class="cf">if</span> (<span class="op">!</span>rv<span class="op">$</span>stream) <span class="kw">return</span>()
    
    <span class="co"># re-execute this code block to every 100 milliseconds</span>
    <span class="kw">invalidateLater</span>(<span class="dv">100</span>, session)
    <span class="co"># changing a reactive value &quot;invalidates&quot; it, so isolate() is needed </span>
    <span class="co"># to avoid recursion</span>
    <span class="kw">isolate</span>({
      rv<span class="op">$</span>n &lt;-<span class="st"> </span>rv<span class="op">$</span>n <span class="op">+</span><span class="st"> </span><span class="dv">1</span>
      rv<span class="op">$</span>yend &lt;-<span class="st"> </span>rv<span class="op">$</span>yend <span class="op">+</span><span class="st"> </span><span class="kw">sample</span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>), <span class="dv">1</span>)
    })
    
    <span class="co"># add the new value to the plot</span>
    <span class="kw">plotlyProxy</span>(<span class="st">&quot;plot&quot;</span>, session) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">plotlyProxyInvoke</span>(
        <span class="st">&quot;extendTraces&quot;</span>, 
        <span class="kw">list</span>(
          <span class="dt">y =</span> <span class="kw">list</span>(<span class="kw">list</span>(rv<span class="op">$</span>yend)), 
          <span class="dt">x =</span> <span class="kw">list</span>(<span class="kw">list</span>(rv<span class="op">$</span>n))
        ), 
        <span class="kw">list</span>(<span class="dv">0</span>)
      )
  })
  
}

<span class="kw">shinyApp</span>(ui, server)</code></pre>
<div class="figure"><span id="fig:shiny-stream"></span>
<iframe src="https://player.vimeo.com/video/307598387?title=0&amp;byline=0&amp;portrait=0" width="100%" height="400" frameborder="0" seamless="seamless" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<p class="caption">
FIGURE 7.20: Using <code>Plotly.extendTraces()</code> to efficiently stream data into a plotly chart. This specific example implements a random walk (using R’s random number generator) which updates every 100 milliseconds.
</p>
</div>
<p>To see more examples that leverage partial updating, see section <a href="advanced-applications.html#crossfilter">7.4.2</a>.</p>
</div>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-2014-latency">
<p>Heer, Zhicheng Liu AND Jeffrey. 2014. “The Effects of Interactive Latency on Exploratory Visual Analysis.” <em>IEEE Trans. Visualization &amp; Comp. Graphics (Proc. InfoVis)</em>. <a href="http://idl.cs.washington.edu/papers/latency">http://idl.cs.washington.edu/papers/latency</a>.</p>
</div>
<div id="ref-profvis">
<p>Chang, Winston, and Javier Luraschi. 2018. <em>Profvis: Interactive Visualizations for Profiling R Code</em>. <a href="https://CRAN.R-project.org/package=profvis">https://CRAN.R-project.org/package=profvis</a>.</p>
</div>
<div id="ref-profvis-shiny">
<p>RStudio. 2014b. “Profvis — Interactive Visualizations for Profiling R Code.” Blog. <a href="https://rstudio.github.io/profvis/examples.html">https://rstudio.github.io/profvis/examples.html</a>.</p>
</div>
<div id="ref-shinyloadtest">
<p>Dipert, Alan, Barret Schloerke, and Barbara Borges. 2018. <em>Shinyloadtest: Load Test Shiny Applications</em>.</p>
</div>
<div id="ref-promises">
<p>Cheng, Joe. 2018b. <em>Promises: Abstractions for Promise-Based Asynchronous Programming</em>. <a href="https://CRAN.R-project.org/package=promises">https://CRAN.R-project.org/package=promises</a>.</p>
</div>
<div id="ref-async">
<p>Cheng, Joe. 2018a. “Case Study: Converting a Shiny App to Async.” Blog. <a href="https://rstudio.github.io/promises/articles/casestudy.html">https://rstudio.github.io/promises/articles/casestudy.html</a>.</p>
</div>
</div>
<script>
  var header = document.querySelector(".book-header h1");

  var img = document.createElement("img");
  img.src = "images/rstudioCloud.svg";
  img.width = 200;
  img.align = "right";
  img.style = "margin-top: 10px";

  var a = document.createElement("a");
  a.href = "https://rstudio.cloud/project/156701";
  a.target = "_blank";
  a.appendChild(img);

  header.appendChild(a);
</script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-60116966-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-60116966-3');
</script>
            </section>

          </div>
        </div>
      </div>
<a href="shiny-plotly-inputs.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="advanced-applications.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook/js/app.min.js"></script>
<script src="libs/gitbook/js/lunr.js"></script>
<script src="libs/gitbook/js/plugin-search.js"></script>
<script src="libs/gitbook/js/plugin-sharing.js"></script>
<script src="libs/gitbook/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook/js/plugin-bookdown.js"></script>
<script src="libs/gitbook/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": false,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/cpsievert/plotly_book/edit/master/linked-views-shiny.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
